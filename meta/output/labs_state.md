# Synesthetic Labs State Report (v0.3.6a)

## Summary of Repo State

- **Environment & configuration**: `.env` loading still works, but the CLI only surfaces Gemini variables—Azure OpenAI and `LABS_EXTERNAL_ENGINE` remain silent, leaving the new spec’s inventory unmet.
- **External contracts**: MCP schema resolution succeeds, yet Gemini requests keep the legacy `$ref` pointer, the Azure chat-completions path is absent, and response parsing depends on deprecated `function_call` fallbacks.
- **Normalization & provenance**: Legacy (`0.7.3`) normalization retains provenance and never backfills empty sections, while 0.7.4+ provenance omits endpoint/deployment/input parameter fields mandated by the enriched schema.
- **Lifecycle & logging**: Retry logic and structured logging largely function, but `invoke_mcp` never runs, relaxed CLI runs skip persistence, and external logs omit deployment metadata.

## Alignment

| Rule | Status | Evidence |
| --- | --- | --- |
| `env-preload-v0.3.6a` | Divergent | `labs/cli.py`: `_load_env_file()` seeds defaults for `GEMINI_MODEL`, `LABS_FAIL_FAST`, and `LABS_SCHEMA_VERSION`, with no mention of `LABS_EXTERNAL_ENGINE` or any `AZURE_OPENAI_*` variables.<br>`labs/cli.py`: the warning loop only checks `GEMINI_API_KEY` and `LABS_EXTERNAL_LIVE`, so Azure credentials and deployment settings are never surfaced.<br>`requirements.txt`: `python-dotenv==1.1.1` confirms env preload support while highlighting the missing Azure exposure. |
| `mcp-schema-pull-v0.3.6a` | Present | `labs/generator/external.py`: `_cached_schema_descriptor()` calls `get_schema("synesthetic-asset", version=...)` and returns `(schema_id, version, schema)` for downstream binding.<br>`labs/generator/external.py`: `_schema_descriptor()` normalizes versions and memoizes the MCP lookup before request construction.<br>`tests/test_mcp_schema_pull.py`: `test_mcp_schema_pull` imports `get_schema`/`list_schemas` and asserts the returned payloads are `ok` with expected properties. |
| `gemini-schema-binding-v0.3.6a` | Divergent | `labs/generator/external.py`: `_build_request()` assigns `generation_config["response_schema"] = {"$ref": schema_id}` and never wraps the sanitized schema under `jsonSchema`.<br>`labs/generator/external.py`: `_sanitize_schema_for_gemini()` exists but is unused in the request path, so unsupported JSON Schema keys are never stripped.<br>`tests/test_external_generator.py`: `test_gemini_build_request_injects_response_mime_type` still expects the bare `$ref`, reflecting the outdated contract. |
| `azure-schema-binding-v0.3.6a` | Missing | `labs/generator/external.py`: `OpenAIGenerator` targets `https://api.openai.com/v1/chat/completions` and reads `OPENAI_*` env vars—there is no Azure-specific generator or request builder.<br>`labs/generator/external.py`: the file contains no references to `AZURE_OPENAI_DEPLOYMENT`, `response_format`, or `json_object` handling.<br>`tests/test_external_generator.py`: the suite exercises `OpenAIGenerator` only, leaving Azure chat-completions unimplemented and untested. |
| `response-parse-v0.3.6a` | Divergent | `labs/generator/external.py`: `GeminiGenerator._parse_response()` searches for `function_call` payloads before falling back to text, instead of deterministically decoding `candidates[0].content.parts[0].text`.<br>`labs/generator/external.py`: `OpenAIGenerator._parse_response()` expects a ready-made `response["asset"]` dict and never reads `response.choices[0].message.content` for JSON decoding.<br>`tests/test_external_generator.py`: no test asserts the new deterministic text parsing flows for Gemini or Azure/OpenAI responses. |
| `normalization-schema-0.7.3-v0.3.6a` | Divergent | `labs/generator/assembler.py`: `_normalize_0_7_3()` copies `meta_info["provenance"]` into the legacy payload even though the 0.7.3 schema must omit provenance fields.<br>`labs/generator/assembler.py`: the legacy path returns whatever section data arrived—there is no `_fill_empty_sections` or `AssetAssembler.default_*` fallback to guarantee populated shader/tone/haptic/control scaffolds.<br>`tests/test_generator.py`: `test_generator_propose_legacy_schema` still expects `meta_info["provenance"]["generator"]`, confirming the divergence. |
| `provenance-enriched-schema-v0.3.6a` | Divergent | `labs/generator/assembler.py`: `_build_asset_provenance()` omits `endpoint`, `deployment`, `api_version`, and `input_parameters`, so enriched assets lack the required provenance fields.<br>`labs/generator/external.py`: `_make_provenance_block()` stores `endpoint` and `input_parameters`, but assembler-built assets never add deployment data for deterministic runs.<br>`tests/test_generator.py`: enriched schema tests only assert that provenance exists, not that the new fields are present. |
| `cli-validation-flow-v0.3.6a` | Missing | `labs/cli.py`: the generate flow builds a `CriticAgent` and calls `critic.review(asset)` but never invokes an `invoke_mcp(asset, strict=...)` helper or honours the CLI strict/relaxed flags via that API.<br>`labs/mcp/validate.py`: the module exports `validate_asset`/`validate_many` only—there is no `invoke_mcp` entry point for the CLI to call. |
| `error-handling-retry-v0.3.6a` | Present | `labs/generator/external.py`: `_classify_http_error()` retries `429` and `5xx` responses while classifying `4xx` (e.g. auth errors) as non-retryable.<br>`labs/generator/external.py`: `_compute_backoff()` caps exponential wait times and injects jitter to stay within retry limits.<br>`tests/test_external_generator.py`: `test_rate_limited_retries` vs. `test_no_retry_on_auth_error` confirm 503/429 retries and immediate 401/403 failures. |
| `structured-logging-v0.3.6a` | Divergent | `labs/generator/external.py`: `record_run()` records engine, endpoint, schema binding, and validation status but never includes a `deployment` field for Azure/OpenAI runs.<br>`labs/logging.py`: `log_external_generation()` simply dumps whatever dict it receives, so missing deployment metadata propagates to `external.jsonl`.<br>`tests/test_external_generator.py`: log assertions cover engine/schema_binding but do not enforce deployment logging, leaving the gap untested. |
| `validation-passes-v0.3.6a` | Divergent | `labs/cli.py`: assets are persisted only when `_review_mcp_ok(review)` is true; relaxed-mode failures log a warning and skip `_persist_asset`, contradicting the spec’s “persist with warnings”.<br>`tests/test_pipeline.py`: `test_cli_generate_relaxed_mode_warns_validation` asserts `experiment_path` remains `None` and no files are written in relaxed mode.<br>`labs/mcp/validate.py`: lacking an `invoke_mcp` wrapper makes strict validation dependent on CriticAgent heuristics rather than the specified MCP call. |
| `fallback-filling-v0.3.6a` | Missing | `labs/generator/assembler.py`: neither `generate()` nor the legacy helpers call `_fill_empty_sections`; the class exposes no such routine despite the spec’s requirement.<br>`labs/generator/assembler.py`: section construction copies generator outputs directly, so empty structures are not replaced by deterministic defaults when upstream payloads are sparse.<br>`tests/test_generator.py`: there are no assertions that empty shader/tone/haptic/control inputs are backfilled, leaving the fallback behaviour unimplemented. |

## Top gaps & fixes

1. **Environment surfacing**: Expand `_load_env_file()` to seed and warn on `LABS_EXTERNAL_ENGINE`, all `AZURE_OPENAI_*` variables, and retain Gemini defaults so operators see every required knob.
2. **External request contracts**: Sanitize the MCP schema into `generation_config.response_schema.jsonSchema`, add Azure chat-completions support (model from `AZURE_OPENAI_DEPLOYMENT`, `response_format={'type':'json_object'}`), and update tests to lock the new payloads.
3. **Parsing & provenance**: Simplify Gemini parsing to `candidates[0].content.parts[0].text`, teach Azure/OpenAI to decode `choices[0].message.content`, and enrich provenance with endpoint, deployment, api_version, and input parameters across assembler outputs.
4. **Lifecycle remediation**: Introduce `invoke_mcp()` in `labs/mcp/validate.py`, route CLI strict/relaxed flows through it, persist relaxed assets with warnings, and add fallback section fillers for legacy schema normalization.

## Recommendations

- Add regression tests covering sanitized Gemini requests, Azure chat payloads, and the deterministic text-parsing contract for both engines.
- Strengthen assembler tests to assert legacy assets omit provenance, enriched assets include endpoint/deployment/input parameters, and empty sections are filled via new helpers.
- Extend CLI and logging tests to verify `invoke_mcp` wiring, relaxed persistence, and deployment metadata in `external.jsonl`.
