{
  "version": "v0.3.5",
  "spec_ref": "docs/specs/synesthetic_labs_v0.3.5.md#synesthetic-labs--spec-v0.3.5",
  "output": {
    "paths": ["meta/output/labs_state.md", "AGENTS.md"],
    "format": "markdown",
    "must_write": true
  },
  "rules": [
    {
      "id": "env-preload-v0.3.5",
      "section": "2 · Environment",
      "requirement": "CLI must preload .env and use GEMINI_MODEL, GEMINI_API_KEY, and LABS_FAIL_FAST variables.",
      "verify": [
        {"path": "labs/cli.py", "match": ["dotenv", "load", "GEMINI_MODEL", "GEMINI_API_KEY", "LABS_FAIL_FAST"]},
        {"path": "requirements.txt", "match": ["python-dotenv"]}
      ]
    },
    {
      "id": "external-live-toggle-v0.3.5",
      "section": "2 · Environment",
      "requirement": "The LABS_EXTERNAL_LIVE environment variable MUST be checked to enable/disable live API calls.",
      "verify": [
        {"path": "labs/cli.py", "match": ["LABS_EXTERNAL_LIVE"]},
        {"path": ".env.example", "match": ["LABS_EXTERNAL_LIVE"], "absent": false}
      ]
    },
    {
      "id": "mcp-schema-pull-v0.3.5",
      "section": "4 · Schema Retrieval",
      "requirement": "Labs MUST call mcp.core.get_schema('synesthetic-asset') and use returned schema for normalization defaults and $schema URL.",
      "verify": [
        {"path": "labs/generator/external.py", "match": ["from mcp.core import get_schema", "get_schema(", "\"synesthetic-asset\""]},
        {"path": "labs/generator.py", "match": ["schema_resp", "schema = schema_resp", "$schema", "default", "examples"]},
        {"path": "tests/test_mcp_schema_pull.py", "match": ["get_schema", "list_schemas", "assert", "ok"]}
      ]
    },
    {
      "id": "gemini-request-structure-v0.3.5",
      "section": "4 · Request / Response",
      "requirement": "Gemini request MUST include contents/parts/text and generationConfig.responseMimeType='application/json'.",
      "verify": [
        {"path": "labs/generator/external.py", "match": ["contents", "parts", "text", "generationConfig", "responseMimeType", "application/json"]}
      ]
    },
    {
      "id": "gemini-response-parse-v0.3.5",
      "section": "4 · Request / Response",
      "requirement": "Response MUST be parsed from candidates[0].content.parts[0].text and json-decoded.",
      "verify": [
        {"path": "labs/generator/external.py", "match": ["candidates[0].content.parts[0].text", "json.loads"]},
        {"path": "tests/test_external_generator.py", "match": ["candidates", "parts", "json"]}
      ]
    },
    {
      "id": "normalization-schema-0.7.3-v0.3.5",
      "section": "5 · Lifecycle",
      "requirement": "When schema_version == '0.7.3', asset MUST include a top-level '$schema' and omit provenance, parameters, and enrichment fields.",
      "verify": [
        {"path": "labs/generator.py", "match": ["if schema_version == '0.7.3'", "asset['$schema']", "pop('provenance')", "normalize_0_7_3"]},
        {"path": "tests/test_generator.py", "match": ["0.7.3", "assert '$schema' in result", "not in result", "'provenance'"]}
      ]
    },
    {
      "id": "normalization-enriched-schema-v0.3.5",
      "section": "5 · Lifecycle & 6 · Provenance",
      "requirement": "For schema_version >= '0.7.4', asset MUST include a '$schema' key and full provenance object with engine, endpoint, trace_id, and input_parameters.",
      "verify": [
        {"path": "labs/generator.py", "match": ["if schema_version >= '0.7.4'", "build_provenance", "engine", "endpoint", "trace_id", "input_parameters"]},
        {"path": "tests/test_generator.py", "match": ["0.7.4", "assert 'provenance' in result"]}
      ]
    },
    {
      "id": "error-handling-retry-v0.3.5",
      "section": "7 · Error Classes",
      "requirement": "Network/server errors (5xx) MUST be retried up to 3 times; client errors (4xx) MUST fail immediately.",
      "verify": [
        {"path": "labs/generator/external.py", "match": ["retry", "status_code >= 500"]},
        {"path": "tests/test_external_generator.py", "match": ["retry", "no-retry", "400", "503"]}
      ]
    },
    {
      "id": "structured-logging-v0.3.5",
      "section": "8 · Logging",
      "requirement": "Events MUST be logged as structured JSON to external.jsonl, including engine, endpoint, trace_id, and taxonomy.",
      "verify": [
        {"path": "labs/logging.py", "match": ["external.jsonl", "json.dumps"]},
        {"path": "labs/generator/external.py", "match": ["log_event", "taxonomy", "trace_id"]}
      ]
    },
    {
      "id": "mcp-validation-flow-v0.3.5",
      "section": "5 · Lifecycle & 7 · Error Classes",
      "requirement": "The lifecycle MUST invoke MCP validation and obey strict/relaxed modes based on LABS_FAIL_FAST or CLI flags.",
      "verify": [
        {"path": "labs/cli.py", "match": ["invoke_mcp", "LABS_FAIL_FAST", "--strict", "--relaxed"]},
        {"path": "tests/test_cli.py", "match": ["mock_mcp", "strict", "relaxed"]}
      ]
    },
    {
      "id": "mcp-version-aware-validator-v0.3.5",
      "section": "5 · Lifecycle",
      "requirement": "_resolve_schema_path() MUST extract version (e.g., 0.7.3 / 0.7.4) from $schema and resolve to meta/schemas/<version>/<filename>, falling back when missing.",
      "verify": [
        {"path": "labs/mcp/validate.py", "match": ["_resolve_schema_path", "re.search", "version", "meta/schemas", "candidate.exists", "return candidate"]},
        {"path": "tests/test_mcp_validate.py", "match": ["0.7.3", "0.7.4", "validate_asset"]}
      ]
    }
  ],
  "report": {
    "sections": [
      "Summary of repo state",
      "Alignment (table: Rule → Status → Evidence)",
      "Top gaps & fixes",
      "Recommendations"
    ],
    "status_values": ["Present", "Missing", "Divergent"]
  },
  "exit_criteria": [
    "meta/output/labs_state.md non-empty",
    "AGENTS.md overwritten (non-empty)",
    "Every rule reported with Present/Missing/Divergent and ≤3 evidence lines"
  ]
}
