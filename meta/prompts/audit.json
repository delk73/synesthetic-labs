{
  "id": "labs-spec-v2.0.0-audit-r1",
  "type": "codex_audit_prompt",
  "description": "Audit Synesthetic Labs v2.0.0 implementation against version-agnostic standup spec (MCP-driven, TCP-only, namespace isolation, TDD).",
  "input": {
    "spec_version": "v2.0.0",
    "spec_ref": "docs/labs_spec.md#synesthetic-labs--specification-v2.0.0",
    "target_output": {
      "files": ["meta/output/labs_state.md"],
      "format": "markdown",
      "must_write": true
    },
    "rules_source": "docs/labs_spec.md",
    "ruleset": "version-agnostic foundation, MCP schema authority, telemetry separation, TDD, TCP-only transport, namespace isolation"
  },
  "checks": [
    {
      "id": "mcp-infrastructure-v2.0.0",
      "expect": "MCPClient stable, proven infrastructure - TCP-only transport at tcp://localhost:8765, inline resolution forced, no stdio fallback",
      "files": ["labs/mcp/client.py", "labs/mcp/tcp_client.py", "labs/mcp/exceptions.py"],
      "patterns": ["class MCPClient", "TcpMCPValidator", "tcp://localhost:8765", "resolution=\"inline\"", "MCPUnavailableError", "not", "mcp_stdio"]
    },
    {
      "id": "schema-authority-v2.0.0",
      "expect": "MCP is sole schema authority - fetch_schema() at runtime, load_schema_bundle() returns inline bundle, NO local schema storage in meta/schemas/",
      "files": ["labs/mcp/client.py", "tests/test_mcp.py"],
      "patterns": ["fetch_schema", "load_schema_bundle", "resolution='inline'", "get_schema_from_mcp", "not", "meta/schemas"]
    },
    {
      "id": "version-namespace-isolation-v2.0.0",
      "expect": "Schema versions isolated in labs/v{VERSION}/ and tests/v{VERSION}/ namespaces - no cross-version imports",
      "files": ["labs/", "tests/"],
      "patterns": ["labs/v0_7_3/", "tests/v0_7_3/", "__init__.py", "not", "from labs.v0_7_3", "not", "from labs.v0_7_4"]
    },
    {
      "id": "telemetry-separation-v2.0.0",
      "expect": "Telemetry separate from validation contract - assets sent to MCP contain ONLY schema fields, telemetry wraps validated assets",
      "files": ["labs/mcp/client.py", "tests/test_mcp.py"],
      "patterns": ["confirm", "strict=True", "validate", "not", "trace_id", "not", "engine", "not", "deployment"]
    },
    {
      "id": "tdd-validation-tests-v2.0.0",
      "expect": "Test-driven development - validation tests written FIRST, validate against live MCP (not mocks)",
      "files": ["tests/v0_7_3/test_validation.py"],
      "patterns": ["def test_", "MCPClient", "confirm", "strict=True", "assert result[\"ok\"]", "not", "@patch", "not", "mock"]
    },
    {
      "id": "tcp-transport-only-v2.0.0",
      "expect": "TCP transport only - MCP_ENDPOINT=tcp://localhost:8765 required, no stdio fallback, MCPUnavailableError on connection failure",
      "files": ["labs/mcp/tcp_client.py", "docs/labs_spec.md"],
      "patterns": ["tcp://localhost:8765", "MCPUnavailableError", "socket.create_connection", "not", "stdio", "not", "fallback"]
    },
    {
      "id": "environment-config-v2.0.0",
      "expect": "Version-specific .env.{VERSION} files - LABS_SCHEMA_VERSION, MCP_ENDPOINT, LABS_SCHEMA_RESOLUTION=inline (forced)",
      "files": [".env.0_7_3", "labs/mcp/client.py"],
      "patterns": ["LABS_SCHEMA_VERSION", "MCP_ENDPOINT=tcp://localhost:8765", "LABS_SCHEMA_RESOLUTION", "_normalise_resolution", "forcing inline"]
    },
    {
      "id": "makefile-verification-v2.0.0",
      "expect": "Makefile targets for MCP verification - mcp-check, mcp-list, mcp-schema, mcp-validate, test-v0.7.3",
      "files": ["Makefile"],
      "patterns": ["mcp-check", "mcp-list", "mcp-schema", "mcp-validate", "test-v0.7.3", "nc localhost 8765", "pytest tests/v0_7_3"]
    },
    {
      "id": "spec-ssot-v2.0.0",
      "expect": "labs_spec.md v2.0.0 is SSOT - version-agnostic foundation, 7-phase standup process, architectural principles, exit criteria",
      "files": ["docs/labs_spec.md"],
      "patterns": ["version: v2.0.0", "status: authoritative-ssot", "Phase 1:", "Phase 2:", "Phase 3:", "Exit Criteria", "Architectural Principles"]
    },
    {
      "id": "cleanup-complete-v2.0.0",
      "expect": "v0.3.6a cleanup complete - labs/generator/, labs/agents/, labs/experimental/, labs/cli.py deleted; only MCP infrastructure remains",
      "files": ["labs/"],
      "patterns": ["not", "labs/generator", "not", "labs/agents", "not", "labs/experimental", "not", "labs/cli.py", "labs/mcp/", "labs/logging.py", "labs/core.py"]
    }
  ],
  "report": {
    "sections": [
      "Summary: v2.0.0 foundation state and readiness",
      "Architecture: Alignment with v2.0.0 principles",
      "Phase 1 Status: Test infrastructure for v0_7_3",
      "Next Steps: Phase 2-6 standup roadmap",
      "Gaps & Recommendations"
    ],
    "status_values": ["✅ Present", "❌ Missing", "⚠️ Divergent", "⏳ In Progress"]
  },
  "exit_criteria": [
    "meta/output/labs_state.md written with v2.0.0 assessment",
    "Every architectural principle has ✅/❌/⚠️/⏳ status",
    "Phase 1 completion verified (tests/v0_7_3/ exists and passing)",
    "Clear roadmap for Phase 2-6 provided"
  ]
}
