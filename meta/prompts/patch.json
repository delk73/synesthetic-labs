{
  "task": "Fix GeminiGenerator payload structure",
  "objective": "Ensure the JSON body for Gemini :generateContent requests matches the expected API shape and includes generationConfig.responseMimeType for structured output.",
  "changes": [
    {
      "id": "gemini_payload_fix",
      "description": "Repair _build_request() to emit correct content and generationConfig fields.",
      "edits": [
        {
          "file": "labs/generator/external.py",
          "pattern": "def _build_request",
          "multiple": false,
          "replacement": "def _build_request(self, prompt: str, **kwargs):\n        # Gemini expects 'contents' with 'role' and 'parts', plus generationConfig\n        return {\n            'contents': [\n                {\n                    'role': 'user',\n                    'parts': [{'text': prompt}]\n                }\n            ],\n            'generationConfig': {\n                'responseMimeType': 'application/json'\n            }\n        }"
        }
      ]
    }
  ],
  "constraints": {
    "rules": [
      "Preserve retry/backoff logic and headers.",
      "Inject generationConfig.responseMimeType exactly once.",
      "No connectivity probing or unrelated changes.",
      "Use the same schema branching and provenance stamping."
    ]
  },
  "exit_criteria": [
    "Gemini live requests return 200 with valid structured JSON output.",
    "Tests confirm inclusion of generationConfig.responseMimeType.",
    "No regressions in OpenAI or deterministic generator flows."
  ]
}
