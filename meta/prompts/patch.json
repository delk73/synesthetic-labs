{
  "task": "Enforce MCP validation before persistence in relaxed mode",
  "objective": "Ensure critic always runs MCP validation in both strict and relaxed modes, and prevent CLI persistence when validation was skipped or failed.",
  "changes": [
    {
      "id": "critic_relaxed_validation",
      "description": "Always invoke MCP validation, even in relaxed mode. If unavailable, set ok=False and reason='mcp_unavailable'.",
      "edits": [
        {
          "file": "labs/agents/critic.py",
          "pattern": "if not should_attempt_validation:",
          "multiple": false,
          "replacement": "if not should_attempt_validation:\n        # Relaxed mode must still attempt validation\n        try:\n            validator = build_validator_from_env()\n            review['mcp_response'] = validator.validate(asset)\n            review['ok'] = review['mcp_response'].get('ok', False)\n        except Exception as exc:\n            review['mcp_response'] = {'ok': False, 'reason': 'mcp_unavailable', 'detail': str(exc)}\n            review['ok'] = False\n        if not review['ok']:\n            return review"
        }
      ]
    },
    {
      "id": "cli_persistence_gate",
      "description": "Block CLI persistence if critic returned ok=False or mcp_response missing.",
      "edits": [
        {
          "file": "labs/cli.py",
          "pattern": "if review.get\\('ok', True\\):",
          "multiple": false,
          "replacement": "if review.get('ok', True) and review.get('mcp_response', {}).get('ok', False):"
        }
      ]
    }
  ],
  "constraints": {
    "rules": [
      "Do not modify generator code",
      "Critic must always include an mcp_response object",
      "CLI must not persist assets unless mcp_response.ok is True",
      "Strict mode remains unchanged; relaxed mode now attempts validation or marks failure"
    ]
  },
  "exit_criteria": [
    "Relaxed mode performs MCP validation or sets mcp_response.reason='mcp_unavailable'",
    "Assets with failed or missing validation are not persisted by CLI",
    "All critic and pipeline tests pass in strict and relaxed modes"
  ]
}
