{
  "task": "Add schema_version branching and $schema enforcement for Labs generator",
  "objective": "Introduce schema_version input (env + CLI), branch generator output between 0.7.3 and 0.7.4+, switch $schema to versioned corpus URLs, and extend external logging with schema_version and null failure entries.",
  "changes": [
    {
      "id": "cli_schema_version",
      "description": "Add --schema-version CLI flag with LABS_SCHEMA_VERSION env fallback (default 0.7.3).",
      "edits": [
        {
          "file": "labs/cli.py",
          "pattern": "parser.add_argument\\('--seed'.*\\)",
          "multiple": true,
          "replacement": "parser.add_argument('--schema-version', type=str, default=os.getenv('LABS_SCHEMA_VERSION', '0.7.3'), help='Target schema version (default: 0.7.3)')\n    parser.add_argument('--seed'"
        }
      ]
    },
    {
      "id": "assembler_branching",
      "description": "Branch AssetAssembler output on schema_version; emit legacy (0.7.3) fields vs enriched (0.7.4+).",
      "edits": [
        {
          "file": "labs/generator/assembler.py",
          "pattern": "def assemble_asset\\(prompt, seed.*\\):",
          "multiple": false,
          "replacement": "def assemble_asset(prompt, seed=None, schema_version='0.7.3', **kwargs):"
        },
        {
          "file": "labs/generator/assembler.py",
          "pattern": "asset = {",
          "multiple": false,
          "replacement": "if schema_version == '0.7.3':\n        asset = {\n            \"$schema\": f\"https://schemas.synesthetic.dev/{schema_version}/SynestheticAsset.schema.json\",\n            \"name\": prompt,\n            # legacy minimal fields only\n        }\n    else:\n        asset = {\n            \"$schema\": f\"https://schemas.synesthetic.dev/{schema_version}/SynestheticAsset.schema.json\",\n            \"asset_id\": str(uuid.uuid4()),\n            \"prompt\": prompt,\n            \"timestamp\": datetime.utcnow().isoformat() + 'Z',\n            \"parameter_index\": [],\n            \"provenance\": {},\n            # enriched fields follow\n        }"
        }
      ]
    },
    {
      "id": "assembler_provenance",
      "description": "Embed provenance consistently under meta_info.provenance for 0.7.3 and top-level provenance for >=0.7.4.",
      "edits": [
        {
          "file": "labs/generator/assembler.py",
          "pattern": "asset\\[\"provenance\"\\] =.*",
          "multiple": true,
          "replacement": "if schema_version == '0.7.3':\n        asset.setdefault('meta_info', {})['provenance'] = provenance\n    else:\n        asset['provenance'] = provenance"
        }
      ]
    },
    {
      "id": "external_logging_schema",
      "description": "Extend external generator logs to include schema_version, $schema, and null failure on success.",
      "edits": [
        {
          "file": "labs/generator/external.py",
          "pattern": "entry = {",
          "multiple": false,
          "replacement": "entry = {\n        \"schema_version\": schema_version,\n        \"$schema\": asset.get('$schema'),"
        },
        {
          "file": "labs/generator/external.py",
          "pattern": "entry\\[\"mcp_result\"\\] =.*",
          "multiple": true,
          "replacement": "entry[\"mcp_result\"] = mcp_result\n    if entry.get(\"failure\") is None:\n        entry[\"failure\"] = null"
        }
      ]
    },
    {
      "id": "docs_update",
      "description": "Update labs_spec.md and README to document schema_version branching and $schema URLs.",
      "edits": [
        {
          "file": "docs/labs_spec.md",
          "pattern": "## Scope.*",
          "multiple": false,
          "replacement": "## Scope (v0.3.5 Schema-Aware Generator)\n\nGenerator now accepts --schema-version/ LABS_SCHEMA_VERSION, defaults to 0.7.3. Assets include top-level $schema pointing to https://schemas.synesthetic.dev/<version>/. Branching rules:\n- 0.7.3: legacy minimal fields (root name).\n- >=0.7.4: enriched fields (asset_id, prompt, timestamp, parameter_index, provenance, effects, input_parameters)."
        },
        {
          "file": "README.md",
          "pattern": "Labs generator.*",
          "multiple": true,
          "replacement": "Labs generator emits schema-valid assets for the requested schema_version (default 0.7.3). Use --schema-version flag or LABS_SCHEMA_VERSION env. Assets must include a top-level $schema URL from https://schemas.synesthetic.dev/<version>/."
        }
      ]
    }
  ],
  "constraints": {
    "rules": [
      "No new dependencies",
      "Keep CLI default schema_version=0.7.3",
      "Only generator, assembler, external logging, and docs are modified"
    ]
  },
  "exit_criteria": [
    "CLI and env allow setting schema_version; default 0.7.3",
    "AssetAssembler branches correctly: legacy vs enriched",
    "All assets include $schema URL from corpus",
    "Provenance placement matches schema_version",
    "external.jsonl entries include schema_version, $schema, and failure: null on success",
    "README and labs_spec.md document schema-version branching",
    "pytest passes with schema_version=0.7.3 and 0.7.4 runs"
  ]
}
