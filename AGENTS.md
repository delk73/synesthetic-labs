# Synesthetic Labs State Report (v0.3.6a)

## Summary of Repo State

- **Environment & configuration**: `.env` loading lands, but the CLI only warns about Gemini keys—Azure OpenAI and `LABS_EXTERNAL_ENGINE` remain silent against the new inventory.
- **External contracts**: MCP schema lookup works, yet Gemini requests keep the bare `$ref`, response parsing leans on `function_call`, and there is no Azure chat-completions implementation.
- **Normalization & provenance**: 0.7.3 assets still carry provenance and never backfill blank sections; enriched assets miss endpoint/deployment/input parameter provenance fields.
- **Lifecycle & logging**: Retrying and logging are in place, but the CLI skips `invoke_mcp`, relaxed runs don’t persist, and external logs omit deployment metadata.

## Alignment

| Rule | Status | Evidence |
| --- | --- | --- |
| `env-preload-v0.3.6a` | Divergent | `labs/cli.py`: `_load_env_file()` seeds defaults for `GEMINI_MODEL`, `LABS_FAIL_FAST`, and `LABS_SCHEMA_VERSION`, leaving `LABS_EXTERNAL_ENGINE` and all `AZURE_OPENAI_*` variables untouched.<br>`labs/cli.py`: the warning loop only covers `GEMINI_API_KEY` and `LABS_EXTERNAL_LIVE`, so Azure credentials never surface.<br>`requirements.txt`: `python-dotenv==1.1.1` shows env preload is wired, underscoring the missing Azure visibility. |
| `mcp-schema-pull-v0.3.6a` | Present | `labs/generator/external.py`: `_cached_schema_descriptor()` wraps `get_schema("synesthetic-asset", version)` and returns `(schema_id, version, schema)` for downstream use.<br>`labs/generator/external.py`: `_schema_descriptor()` normalizes the requested version and memoizes the MCP lookup.<br>`tests/test_mcp_schema_pull.py`: `test_mcp_schema_pull` asserts both `list_schemas()` and `get_schema()` succeed and expose the required properties. |
| `gemini-schema-binding-v0.3.6a` | Divergent | `labs/generator/external.py`: `_build_request()` only writes `generation_config["response_schema"] = {"$ref": schema_id}`—no `jsonSchema` envelope or `_sanitize_schema_for_gemini()` call.<br>`labs/generator/external.py`: although `_sanitize_schema_for_gemini()` exists, the request builder never invokes it, leaving unsupported keys intact.<br>`tests/test_external_generator.py`: `test_gemini_build_request_injects_response_mime_type` still expects the legacy `$ref` pointer. |
| `azure-schema-binding-v0.3.6a` | Missing | `labs/generator/external.py`: only `OpenAIGenerator` is defined, targeting `https://api.openai.com/v1/chat/completions` with `OPENAI_*` env vars—no Azure variant or deployment lookup.<br>`labs/generator/external.py`: there are no references to `AZURE_OPENAI_DEPLOYMENT`, `response_format`, or `json_object` formatting.<br>`tests/test_external_generator.py`: every external-engine test instantiates `OpenAIGenerator`, so the Azure chat contract is unimplemented and untested. |
| `response-parse-v0.3.6a` | Divergent | `labs/generator/external.py`: `GeminiGenerator._parse_response()` hunts for `function_call` content before falling back to text, rather than deterministically using `candidates[0].content.parts[0].text`.<br>`labs/generator/external.py`: `OpenAIGenerator._parse_response()` consumes `response["asset"]` directly and never reads `response.choices[0].message.content`.<br>`tests/test_external_generator.py`: there is no coverage locking the new deterministic parsing requirements. |
| `normalization-schema-0.7.3-v0.3.6a` | Divergent | `labs/generator/assembler.py`: `_normalize_0_7_3()` injects `meta_info["provenance"]` into the legacy payload, violating the spec’s provenance omission rule.<br>`labs/generator/assembler.py`: the function returns sections as-is without `_fill_empty_sections` or default scaffolds, so empty inputs stay empty.<br>`tests/test_generator.py`: `test_generator_propose_legacy_schema` still asserts `meta_info["provenance"]["generator"]`, reflecting the divergence. |
| `provenance-enriched-schema-v0.3.6a` | Divergent | `labs/generator/assembler.py`: `_build_asset_provenance()` omits `endpoint`, `deployment`, `api_version`, and `input_parameters` required for schema ≥0.7.4.<br>`labs/generator/external.py`: `_make_provenance_block()` handles endpoint/input parameters only for external engines, leaving assembler-generated assets under-specified.<br>`tests/test_generator.py`: enriched tests merely check provenance exists, not that the mandated fields are populated. |
| `cli-validation-flow-v0.3.6a` | Missing | `labs/cli.py`: the generate command calls `critic.review(asset)` and branches on `_review_mcp_ok(review)`—`invoke_mcp` is never invoked with strict/relaxed semantics.<br>`labs/mcp/validate.py`: exposes `validate_asset`/`validate_many` only, so there is no entry point for the CLI to delegate MCP validation. |
| `error-handling-retry-v0.3.6a` | Present | `labs/generator/external.py`: `_classify_http_error()` retries `429`/`5xx` responses while failing fast on `4xx` auth errors.<br>`labs/generator/external.py`: `_compute_backoff()` enforces capped exponential backoff with jitter.<br>`tests/test_external_generator.py`: `test_rate_limited_retries` and `test_no_retry_on_auth_error` assert the retry vs. fail-fast behaviour. |
| `structured-logging-v0.3.6a` | Divergent | `labs/generator/external.py`: `record_run()` logs engine, endpoint, and schema binding but never includes a `deployment` field for Azure/OpenAI contexts.<br>`labs/logging.py`: `log_external_generation()` dumps the record verbatim, so missing deployment metadata hits disk.<br>`tests/test_external_generator.py`: assertions verify schema binding but not deployment logging, leaving the gap unguarded. |
| `validation-passes-v0.3.6a` | Divergent | `labs/cli.py`: `_persist_asset()` runs only when `_review_mcp_ok(review)` is true; relaxed failures warn and skip persistence.<br>`tests/test_pipeline.py`: `test_cli_generate_relaxed_mode_warns_validation` checks that `experiment_path` stays `None` and no files are emitted in relaxed mode.<br>`labs/mcp/validate.py`: without `invoke_mcp`, strict validation hinges on CriticAgent responses rather than the specified MCP call. |
| `fallback-filling-v0.3.6a` | Missing | `labs/generator/assembler.py`: there is no `_fill_empty_sections` helper or call—sections are returned exactly as provided.<br>`labs/generator/assembler.py`: shader/tone/haptic/control blocks are built by copying generator outputs, so empty inputs are not replaced with deterministic defaults.<br>`tests/test_generator.py`: no test asserts that blank sections are backfilled, leaving the behaviour unimplemented. |

## Top gaps & fixes

1. **Broaden env surfacing**: Warn on `LABS_EXTERNAL_ENGINE` and every `AZURE_OPENAI_*` variable alongside the existing Gemini keys.
2. **Modernize external contracts**: Bind sanitized schemas under `generation_config.response_schema.jsonSchema`, implement Azure chat-completions (`model=os.getenv("AZURE_OPENAI_DEPLOYMENT")`, `response_format={'type':'json_object'}`), and add tests.
3. **Fix parsing & provenance**: Parse Gemini via the first text part, decode Azure/OpenAI JSON from `choices[0].message.content`, and enrich provenance with endpoint/deployment/api_version/input parameters for both assembler and external runs.
4. **Repair lifecycle**: Provide `invoke_mcp()` in `labs/mcp/validate.py`, route CLI strict/relaxed flows through it, persist relaxed assets with warnings, and add section-fill helpers for legacy normalization.

## Recommendations

- Write regression tests that lock sanitized Gemini payloads, Azure chat contracts, and deterministic parsing behaviour.
- Extend assembler and provenance tests to assert the new enriched fields and legacy provenance omissions.
- Update CLI and logging tests to confirm `invoke_mcp` usage, relaxed persistence, and deployment metadata in `external.jsonl`.
